function e(t={}){const r=Object.setPrototypeOf({_v:t.v,_cmp:t.compare,_rdy:!0,_eager:t.eager,_pros:new Set,_cons:new Set},e._prototype);return void 0===t.compare&&(r._cmp=r._defcmp),t.def&&(r.def=t.def),r}(t=>{async function r(){if(!t._evalWait){++t._evalWait;const[e,r,s]=t._REQ,i=e=>{try{e.values().next().value.rv}catch(e){}};let o=performance.now();const _=async()=>{performance.now()-o>=t.sliceTime&&(await new Promise((e=>setTimeout(e,0))),o=performance.now())};for(;t._evalWait<2;){for(const r of e){if(!(t._evalWait<2))break;try{r.rv}catch(e){}finally{await _()}}if(t._evalWait>1)break;if(r.size)i(r);else{if(!s.size)break;i(s)}await _()}--t._evalWait}}t._roPrototype={get $reactive(){return t.type},get readonly(){return!0},get rv(){return this.getter()},toString(){return this.getter().toString()},valueOf(){return this.getter()}},t._prototype=Object.setPrototypeOf({get accessors(){return[this.getter,this.setter]},get compare(){return this._cmp},get def(){return this._def},set def(e){void 0===e?this._def&&(this.provider(null),delete this._def,this._setNotify(void 0)):"function"==typeof e?(this.provider(null),this._def=e,delete this._error,this._rdy=!1,this._schedule()):e?.$reactive===t.type&&(this.def=e.getter)},get eager(){return this._eager},set eager(e){this._eager=e,this._schedule()},get error(){return this._error},get getter(){return this._g||=()=>this.rv},get $reactive(){return t.type},get readonly(){return!1},get readonlyView(){return this._rov||(this._rov=Object.freeze(Object.setPrototypeOf({get error(){return this._error},getter:this.getter},t._roPrototype))),this._rov},get rv(){if(void 0!==this._sched&&(t._REQ[this._sched].delete(this),delete this._sched),t._consumer&&!t._untrack&&(this.consumer(t._consumer),t._consumer.provider(this)),!this._checkReady()){if(this._busy)throw new ReferenceError("Self-referential reactive definition");this.provider(null);const e=t._consumer;t._consumer=this,this._busy=!0;try{delete this._error;const r=this._def(this._v);delete this._busy,t._consumer=e,this._setNotify(r)}catch(r){throw delete this._busy,t._consumer=e,this._error=r,this._rdy=!0,this.ripple(),this._eager&&!this._cons.size&&queueMicrotask((()=>{throw new Error(`[Reactive] ${r.message}`,{cause:[r,this]})})),r}}if(this._error)throw this._error;return this._v},get setter(){return this._s||=e=>this._set(e)},get wv(){return this.rv},set wv(e){this._def&&(this.def=void 0),this._setNotify(e)},consumer(e,t=!0){t?this._cons.add(e):this._cons.delete(e)},provider(e,t=!0){if(null===e){for(const e of this._pros)e.consumer(this,!1);this._pros.clear()}else t?this._pros.add(e):this._pros.delete(e)},ripple(e=0){const r=this._rdy;if(1===e&&(this._rdy=!1),e>1&&this._rdy&&(this._rdy=void 0),!e||r&&!this._rdy){++t._evalWait;const r=e+1;for(const e of this._cons)e.ripple(r);--t._evalWait}this._schedule(e)},set(e){return this._set(e),this},setDef(e){return this.def=e,this},setEager(e){return this.eager=e,this},unready(){return this._def&&(this._rdy=!1),this._schedule(),this},_checkReady(){if(void 0!==this._rdy)return this._rdy;for(const e of this._pros)if(e.rv,!1===this._rdy)return!1;return this._rdy=!0},_defcmp:(e,t)=>e!==t,_schedule(e=0){this._rdy||void 0!==this._sched||!this._eager&&!this._cons.size||t._queueEval(this,e),t.run()},_set(e){return this._def&&(this.def=void 0),"function"==typeof e?this._setNotify(e(this._v)):this._setNotify(e),this._v},_setNotify(e){const t="function"==typeof this._cmp?this._cmp(this._v,e):this._cmp;this._v=e,this._rdy=!0,delete this._error,t&&this.ripple()}},t._roPrototype),Object.assign(t,{_evalWait:0,sliceTime:5,_tasks:[],_untrack:0,_REQ:[new Set,new Set,new Set],batch(e){++t._evalWait;const r=e();return--t._evalWait,t.run(),r},fv(t,r=!1){for(;t?.$reactive===e.type;)t=t.rv;return r&&"function"==typeof t?._bundle?t._bundle():t},run(){t._evalWait||setTimeout(r,0)},get type(){return 1},typeOf:e=>e?.$reactive,untracked(e){++t._untrack;const r=e();return--t._untrack,r},_queueEval(e,r=0){if(r=Math.min(r,2),"number"==typeof e._sched){if(e._sched<=r)return;t._REQ[e._sched].delete(e)}t._REQ[e._sched=r].add(e)}})})(e);const{batch:t,fv:r,run:s,typeOf:i,untracked:o}=e;export{t as batch,e as default,r as fv,e as reactive,s as run,i as typeOf,o as untracked};
//# sourceMappingURL=reactive.min.esm.js.map
