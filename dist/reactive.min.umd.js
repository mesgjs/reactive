!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).reactive={})}(this,(function(e){"use strict";function t(e={}){const r=Object.setPrototypeOf({_v:e.v,_cmp:e.compare,_rdy:!0,_eager:e.eager,_pros:new Set,_cons:new Set},t._prototype);return void 0===e.compare&&(r._cmp=r._defcmp),e.def&&(r.def=e.def),r}(e=>{async function r(){if(!e._evalWait){++e._evalWait;const[t,r,i]=e._REQ,s=e=>{try{e.values().next().value.rv}catch(e){}};let o=performance.now();const n=async()=>{performance.now()-o>=e.sliceTime&&(await new Promise((e=>setTimeout(e,0))),o=performance.now())};for(;e._evalWait<2;){for(const r of t){if(!(e._evalWait<2))break;try{r.rv}catch(e){}finally{await n()}}if(e._evalWait>1)break;if(r.size)s(r);else{if(!i.size)break;s(i)}await n()}if(--e._evalWait,e._waiting&&!t.size&&!r.size&&!i.size){const t=e._waiting.resolve;e._waiting=void 0,t(!0)}}}e._roPrototype={get $reactive(){return e.type},get readonly(){return!0},get rv(){return this.getter()},toString(){return this.getter().toString()},valueOf(){return this.getter()}},e._prototype=Object.setPrototypeOf({get accessors(){return[this.getter,this.setter]},get compare(){return this._cmp},get def(){return this._def},set def(t){void 0===t?this._def&&(this.provider(null),delete this._def,this._setNotify(void 0)):"function"==typeof t?(this.provider(null),this._def=t,delete this._error,this._rdy=!1,this._schedule()):t?.$reactive===e.type&&(this.def=t.getter)},get eager(){return this._eager},set eager(e){this._eager=e,this._schedule()},get error(){return this._error},get getter(){return this._g||=()=>this.rv},get $reactive(){return e.type},get readonly(){return!1},get readonlyView(){return this._rov||(this._rov=Object.freeze(Object.setPrototypeOf({get error(){return this._error},getter:this.getter},e._roPrototype))),this._rov},get rv(){if(void 0!==this._sched&&(e._REQ[this._sched].delete(this),delete this._sched),e._consumer&&!e._untrack&&(this.consumer(e._consumer),e._consumer.provider(this)),!this._checkReady()){if(this._busy)throw new ReferenceError("Self-referential reactive definition");this.provider(null);const t=e._consumer;e._consumer=this,this._busy=!0;try{delete this._error;const r=this._def(this._v);delete this._busy,e._consumer=t,this._setNotify(r)}catch(r){throw delete this._busy,e._consumer=t,this._error=r,this._rdy=!0,this.ripple(),this._eager&&!this._cons.size&&queueMicrotask((()=>{throw new Error(`[Reactive] ${r.message}`,{cause:[r,this]})})),r}}if(this._error)throw this._error;return this._v},get setter(){return this._s||=e=>this._set(e)},get wv(){return this.rv},set wv(e){this._def&&(this.def=void 0),this._setNotify(e)},consumer(e,t=!0){t?this._cons.add(e):this._cons.delete(e)},provider(e,t=!0){if(null===e){for(const e of this._pros)e.consumer(this,!1);this._pros.clear()}else t?this._pros.add(e):this._pros.delete(e)},ripple(t=0){const r=this._rdy;if(1===t&&(this._rdy=!1),t>1&&this._rdy&&(this._rdy=void 0),!t||r&&!this._rdy){++e._evalWait;const r=t+1;for(const e of this._cons)e.ripple(r);--e._evalWait}this._schedule(t)},set(e){return this._set(e),this},setDef(e){return this.def=e,this},setEager(e){return this.eager=e,this},unready(){return this._def&&(this._rdy=!1),this._schedule(),this},_checkReady(){if(void 0!==this._rdy)return this._rdy;for(const e of this._pros)if(e.rv,!1===this._rdy)return!1;return this._rdy=!0},_defcmp:(e,t)=>e!==t,_schedule(t=0){this._rdy||void 0!==this._sched||!this._eager&&!this._cons.size||e._queueEval(this,t),e.run()},_set(e){return this._def&&(this.def=void 0),"function"==typeof e?this._setNotify(e(this._v)):this._setNotify(e),this._v},_setNotify(e){const t="function"==typeof this._cmp?this._cmp(this._v,e):this._cmp;this._v=e,this._rdy=!0,delete this._error,t&&this.ripple()}},e._roPrototype),Object.assign(e,{_evalWait:0,sliceTime:5,_tasks:[],_untrack:0,_REQ:[new Set,new Set,new Set],batch(t){++e._evalWait;const r=t();return--e._evalWait,e.run(),r},fv(e,r=!1){for(;e?.$reactive===t.type;)e=e.rv;return r&&"function"==typeof e?._bundle?e._bundle():e},run(){e._evalWait||setTimeout(r,0)},get type(){return 1},typeOf:e=>e?.$reactive,untracked(t){++e._untrack;const r=t();return--e._untrack,r},wait(){if(e._waiting)return e._waiting.promise;const[t,r,i]=e._REQ;return e._evalWait||t.size||r.size||i.size?(e._waiting=Promise.withResolvers(),e._waiting.promise):Promise.resolve(!1)},_queueEval(t,r=0){if(r=Math.min(r,2),"number"==typeof t._sched){if(t._sched<=r)return;e._REQ[t._sched].delete(t)}e._REQ[t._sched=r].add(t)}})})(t);const{batch:r,fv:i,run:s,typeOf:o,untracked:n,wait:_}=t;e.batch=r,e.default=t,e.fv=i,e.reactive=t,e.run=s,e.typeOf=o,e.untracked=n,e.wait=_,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=reactive.min.umd.js.map
